# Storage Testbench

**This is not an officially supported Google product**

This repository is used by Storage Client libraries to test integration tests locally
and reproduce Storage API transient errors. The testbench emulates the Storage API and
is expected to be used by Storage library maintainers.


## Table of Contents
* [Issue Policy](#issue-policy)
* [What is this testbench?](#what-is-this-testbench)
* [When to use](#when-to-use-this-testbench)
* [How do I use this testbench?](#how-to-use-this-testvench)
  - [Initial set up](#initial-set-up)
  - [Run the testbench](#run-the-testbench)
  - [Check that the testbench is running](#check-that-the-testbench-is-running)   

## Issue Policy

Repository provides no dedicated support for issues filed.
Issues will be addressed when time permits.

## What is this testbench?

This testbench fakes the Google Cloud Storage (GCS) API. You can configure the GCS client libraries to make calls to this fake rather than to the actual API.
* The testbench fakes the JSON API, both over REST and gRPC. It has limited support for the XML API.
* Generally, the error codes are similar to the ones generated by GCS, but the error messages are not. 
* The testbench performs far fewer error checks, and no permission checks (ACL/IAM). 

## When to use this testbench

In general, this testbench is best suited for integration tests that are hard (or just annoying) to reliably run against production. The primary example of this are errors that make the client library go through its retry path.

This testbench can be useful to test HMAC keys, which are really hard to test against production due to quota restrictions.

It is useful as well to test features that are not yet deployed to production: you can implement them in the testbench and then write the library code before production is "ready".

## How to use this testbench

### Initial set up

1. [Set up python if you haven't already](https://cloud.google.com/python/docs/setup)
2. [Clone this repository](https://docs.github.com/en/github/creating-cloning-and-archiving-repositories/cloning-a-repository-from-github/cloning-a-repository#cloning-a-repository)

   From the terminal:
   ```bash
   git clone https://github.com/googleapis/storage-testbench.git
   ```
3. Switch to the cloned directory:
   ```bash
   cd storage-testbench
    ```
4. [Create a virtual environment](https://cloud.google.com/python/docs/setup#installing_and_using_virtualenv)
    * keep this virtual environment active whenever you run the testbench
5. Install dependencies: 
    ```bash
    pip install -r requirements.txt
    ```
    
### Run the testbench

To start the testbench, run this command from a terminal:

```bash
gunicorn --bind "localhost:9000" --worker-class sync --threads 10 --reload --access-logfile - "emulator:run()"
```

> ⚠️ Ensure that the virtual environment you created to install the dependencies is active.


### Check that the testbench is running

Ensure the testbench is running by sending it a request from a different terminal, such as:

```bash
curl -X GET localhost:9000
```

The response you get should be: `OK`

Now you can use the testbench (while it's running) with the client libraries.

## Updating Proto Files

From time to time you may need to update the files generated by protobuf and
gRPC. To do so, clone the [protos](https://github.com/googleapis/googleapis) and
run the grpc_tools generator:

```shell
cd $HOME
git clone https://github.com/googleapis/googleapis
cd google-cloud-cpp
python -m grpc_tools.protoc -I$HOME/googleapis \
    --python_out=google/cloud/storage/emulator \
    --grpc_python_out=google/cloud/storage/emulator \
    $HOME/googleapis/google/iam/v1/iam_policy.proto
python -m grpc_tools.protoc -I$HOME/googleapis \
    --python_out=google/cloud/storage/emulator \
    --grpc_python_out=google/cloud/storage/emulator \
    $HOME/googleapis/google/iam/v1/options.proto
python -m grpc_tools.protoc -I$HOME/googleapis \
    --python_out=google/cloud/storage/emulator \
    --grpc_python_out=google/cloud/storage/emulator \
    $HOME/googleapis/google/iam/v1/policy.proto
python -m grpc_tools.protoc -I$HOME/googleapis \
    --python_out=google/cloud/storage/emulator \
    --grpc_python_out=google/cloud/storage/emulator \
    $HOME/googleapis/google/storage/v2/storage.proto
```
